@model ProductionPlanningDashboard.Models.ViewModels.DataEntryViewModel
@{
    ViewData["Title"] = "Upper Department Production Entry";
}

<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --upper-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
        --hover-shadow: 0 15px 40px rgba(0,0,0,0.2);
    }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }

    .hero-section {
        background: var(--upper-gradient);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 50px 50px;
        box-shadow: var(--card-shadow);
    }

    .hero-title {
        font-size: 2.5rem;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .hero-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 0;
    }

    .attractive-card {
        background: white;
        border-radius: 20px;
        box-shadow: var(--card-shadow);
        border: none;
        transition: all 0.3s ease;
        overflow: hidden;
        margin-bottom: 2rem;
    }

        .attractive-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

    .card-header-gradient {
        background: var(--upper-gradient);
        color: white;
        padding: 1.5rem;
        border: none;
        font-weight: 600;
    }

    .date-selector {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        border-radius: 15px;
        padding: 2rem;
        margin: 1.5rem 0;
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
    }

    .date-input-group {
        background: white;
        border-radius: 15px;
        padding: 1rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .week-display {
        background: var(--upper-gradient);
        color: white;
        border-radius: 15px;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .week-number-input {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.75rem;
        font-size: 1.1rem;
        font-weight: 600;
        text-align: center;
        transition: all 0.3s ease;
        width: 100%;
    }

        .week-number-input:focus {
            border-color: #11998e;
            box-shadow: 0 0 0 0.2rem rgba(17, 153, 142, 0.25);
        }

    .production-table {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .table-header {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
    }

        .table-header th {
            border: none;
            padding: 1rem;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
        }

    .table tbody tr {
        transition: all 0.3s ease;
    }

        .table tbody tr:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transform: scale(1.02);
        }

    .modern-input {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.75rem;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

        .modern-input:focus {
            border-color: #11998e;
            box-shadow: 0 0 0 0.2rem rgba(17, 153, 142, 0.25);
        }

    .modern-select {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.75rem;
        transition: all 0.3s ease;
        background: white;
    }

        .modern-select:focus {
            border-color: #11998e;
            box-shadow: 0 0 0 0.2rem rgba(17, 153, 142, 0.25);
        }

    .action-buttons {
        padding: 2rem;
        text-align: center;
    }

    .btn-modern {
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        border: none;
        margin: 0.5rem;
    }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

    .btn-save {
        background: var(--upper-gradient);
        color: white;
    }

    .btn-add {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }

    .btn-clear {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
    }

    .btn-back {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #333;
    }

    .difference-badge {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
    }

    .performance-badge {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
        border-radius: 15px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
    }

    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }

    .stats-number {
        font-size: 2rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }

    .stats-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .floating-add-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--upper-gradient);
        color: white;
        border: none;
        font-size: 1.5rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
        z-index: 1000;
    }

        .floating-add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    .pulse {
        animation: pulse 2s infinite;
    }

    keyframes pulse {
        0%

    {
        transform: scale(1);
    }

    50% {
        transform: scale(1.05);
    }

    100% {
        transform: scale(1);
    }

    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

    .line-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .company-name {
        font-weight: 700;
        color: #2d3748;
        font-size: 1.1rem;
    }
</style>

<!-- Hero Section -->
<div class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="hero-title">
                    <i class="bi bi-bezier2 me-3"></i>Upper Department Production Entry
                </h1>
                <p class="hero-subtitle">Enter production data for upper manufacturing lines</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="/Dashboard" class="btn btn-back btn-modern">
                    <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Date Selection Card -->
    <div class="attractive-card fade-in">
        <div class="card-header-gradient">
            <h5 class="mb-0">
                <i class="bi bi-calendar-event me-2"></i>Production Date & Week Selection
            </h5>
        </div>
        <div class="card-body">
            <div class="date-selector">
                <div class="row align-items-center">
                    <div class="col-md-5">
                        <label class="form-label fw-bold mb-3">Select Production Date</label>
                        <div class="date-input-group">
                            <input type="date" id="productionDate" class="form-control modern-input"
                                   value="@Model.SelectedDate.ToString("yyyy-MM-dd")" onchange="updateWeekInfo()">
                            <button class="btn btn-add btn-modern mt-2" onclick="setToday()">
                                <i class="bi bi-calendar-today me-2"></i>Set Today
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2 text-center">
                        <div class="week-display">
                            <i class="bi bi-arrow-left-right fs-2 mb-2"></i>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-bold mb-3">Week Number (Editable)</label>
                        <div class="week-display">
                            <input type="number" id="weekNumber" class="week-number-input"
                                   value="@Model.WeekNumber" min="1" max="53" onchange="updateFromWeek()">
                            <div class="mt-2">
                                <small>Week of <span id="weekYear">@Model.Year</span></small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12 text-center">
                        <div class="stats-card">
                            <div class="stats-label">Selected Date</div>
                            <div class="stats-number text-success" id="displayDate">@Model.SelectedDate.ToString("MMMM dd, yyyy")</div>
                            <div class="stats-label" id="displayDay">@Model.SelectedDate.ToString("dddd")</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-label">Total Lines</div>
                <div class="stats-number text-info" id="totalEntries">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-label">Planned Total</div>
                <div class="stats-number text-primary" id="plannedTotal">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-label">Actual Total</div>
                <div class="stats-number text-success" id="actualTotal">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-label">Efficiency</div>
                <div class="stats-number text-warning" id="efficiency">0%</div>
            </div>
        </div>
    </div>

    <!-- Production Entry Table -->
    <div class="attractive-card fade-in">
        <div class="card-header-gradient">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-task me-2"></i>Upper Department Lines Entry
                </h5>
                <button class="btn btn-add btn-modern" onclick="showAddLineModal()">
                    <i class="bi bi-plus-circle me-2"></i>Add Production Line
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 production-table">
                    <thead class="table-header">
                        <tr>
                            <th><i class="bi bi-building me-2"></i>Company</th>
                            <th><i class="bi bi-gear me-2"></i>Production Line</th>
                            <th><i class="bi bi-box me-2"></i>Unit</th>
                            <th><i class="bi bi-target me-2"></i>Planned Qty</th>
                            <th><i class="bi bi-check-circle me-2"></i>Actual Qty</th>
                            <th><i class="bi bi-graph-up me-2"></i>Difference</th>
                            <th><i class="bi bi-speedometer2 me-2"></i>Performance</th>
                            <th><i class="bi bi-tools me-2"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productionTableBody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div id="emptyState" class="empty-state">
                <i class="bi bi-inbox"></i>
                <h4>No Production Lines Added Yet</h4>
                <p>Click "Add Production Line" to start entering your upper department production data</p>
                <button class="btn btn-add btn-modern pulse" onclick="showAddLineModal()">
                    <i class="bi bi-plus-circle me-2"></i>Add Your First Line
                </button>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button class="btn btn-save btn-modern" onclick="saveUpperData()">
            <i class="bi bi-floppy me-2"></i>Save All Data
        </button>
        <button class="btn btn-clear btn-modern" onclick="clearAllData()">
            <i class="bi bi-trash me-2"></i>Clear All
        </button>
    </div>
</div>

<!-- Floating Add Button -->
<button class="floating-add-btn" onclick="showAddLineModal()">
    <i class="bi bi-plus"></i>
</button>

<!-- Add Line Modal -->
<div class="modal fade" id="addLineModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 20px; overflow: hidden;">
            <div class="modal-header" style="background: var(--upper-gradient); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>Add Upper Department Production Line
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-building me-1"></i>Select Company
                        </label>
                        <select id="modalCompanySelect" class="form-select modern-select" onchange="loadCompanyLines()">
                            <option value="">Choose Company...</option>
                            @foreach (var company in Model.Companies)
                            {
                                <option value="@company.Id">@company.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-gear me-1"></i>Select Production Line
                        </label>
                        <select id="modalLineSelect" class="form-select modern-select" onchange="loadCompanyUnits()">
                            <option value="">Choose Line...</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-box me-1"></i>Select Unit
                        </label>
                        <select id="modalUnitSelect" class="form-select modern-select">
                            <option value="">Choose Unit...</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-target me-1"></i>Planned Quantity
                        </label>
                        <div class="input-group">
                            <input type="number" id="modalPlannedQty" class="form-control modern-input"
                                   min="0" step="0.01" placeholder="Enter planned quantity">
                            <span class="input-group-text">units</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-check-circle me-1"></i>Actual Quantity
                        </label>
                        <div class="input-group">
                            <input type="number" id="modalActualQty" class="form-control modern-input"
                                   min="0" step="0.01" placeholder="Enter actual quantity">
                            <span class="input-group-text">units</span>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="alert alert-info border-0" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                        <i class="bi bi-lightbulb text-info me-2"></i>
                        <strong>Tip:</strong> Performance will be calculated automatically as (Actual ÷ Planned) × 100%
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-clear btn-modern" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-add btn-modern" onclick="addLineEntry()">
                    <i class="bi bi-check-circle me-2"></i>Add Entry
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let lineEntries = [];
        let companies = @Html.Raw(Json.Serialize(Model.Companies));
        const departmentId = 2; // Upper Department ID

        // Initialize page
        $(document).ready(function() {
            updateWeekInfo();
            loadExistingData();
            updateStats();
        });

        // Date and Week functions
        function updateWeekInfo() {
            const date = new Date(document.getElementById('productionDate').value);
            const weekNumber = getWeekNumber(date);

            document.getElementById('weekNumber').value = weekNumber;
            document.getElementById('weekYear').textContent = date.getFullYear();
            document.getElementById('displayDate').textContent = formatDate(date);
            document.getElementById('displayDay').textContent = date.toLocaleDateString('en-US', { weekday: 'long' });
        }

        function updateFromWeek() {
            const weekNumber = parseInt(document.getElementById('weekNumber').value);
            const year = parseInt(document.getElementById('weekYear').textContent);

            if (weekNumber >= 1 && weekNumber <= 53) {
                const date = getDateFromWeek(year, weekNumber);
                document.getElementById('productionDate').value = date.toISOString().split('T')[0];
                updateWeekInfo();
                loadDataForDate();
            }
        }

        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        function getDateFromWeek(year, week) {
            const firstDayOfYear = new Date(year, 0, 1);
            const days = (week - 1) * 7 - firstDayOfYear.getDay() + 1;
            return new Date(year, 0, days);
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function setToday() {
            const today = new Date();
            document.getElementById('productionDate').value = today.toISOString().split('T')[0];
            updateWeekInfo();
            loadDataForDate();
        }

        // Modal functions
        function showAddLineModal() {
            document.getElementById('modalCompanySelect').value = '';
            document.getElementById('modalLineSelect').innerHTML = '<option value="">Choose Line...</option>';
            document.getElementById('modalUnitSelect').innerHTML = '<option value="">Choose Unit...</option>';
            document.getElementById('modalPlannedQty').value = '';
            document.getElementById('modalActualQty').value = '';
            new bootstrap.Modal(document.getElementById('addLineModal')).show();
        }

        function loadCompanyLines() {
            const companyId = document.getElementById('modalCompanySelect').value;
            const lineSelect = document.getElementById('modalLineSelect');
            const unitSelect = document.getElementById('modalUnitSelect');

            // Reset line and unit dropdowns
            lineSelect.innerHTML = '<option value="">Choose Line...</option>';
            unitSelect.innerHTML = '<option value="">Choose Unit...</option>';

            if (!companyId) {
                return;
            }

            lineSelect.innerHTML = '<option value="">Loading...</option>';

            fetch(`/DataEntry/GetLinesByCompany?companyId=${companyId}&departmentId=${departmentId}`)
                .then(response => response.json())
                .then(lines => {
                    lineSelect.innerHTML = '<option value="">Choose Line...</option>';
                    lines.forEach(line => {
                        lineSelect.innerHTML += `<option value="${line.id}">${line.name}</option>`;
                    });
                })
                .catch(error => {
                    console.error('Error loading lines:', error);
                    lineSelect.innerHTML = '<option value="">Error loading lines</option>';
                });
        }

        function loadCompanyUnits() {
            const companyId = document.getElementById('modalCompanySelect').value;
            const unitSelect = document.getElementById('modalUnitSelect');

            if (!companyId) {
                unitSelect.innerHTML = '<option value="">Choose Unit...</option>';
                return;
            }

            unitSelect.innerHTML = '<option value="">Loading...</option>';

            fetch(`/DataEntry/GetUnitsByCompany?companyId=${companyId}`)
                .then(response => response.json())
                .then(units => {
                    unitSelect.innerHTML = '<option value="">Choose Unit...</option>';
                    units.forEach(unit => {
                        unitSelect.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
                    });
                })
                .catch(error => {
                    console.error('Error loading units:', error);
                    unitSelect.innerHTML = '<option value="">Error loading units</option>';
                });
        }

        function addLineEntry() {
            const companyId = document.getElementById('modalCompanySelect').value;
            const lineId = document.getElementById('modalLineSelect').value;
            const unitId = document.getElementById('modalUnitSelect').value;
            const plannedQty = parseFloat(document.getElementById('modalPlannedQty').value) || 0;
            const actualQty = parseFloat(document.getElementById('modalActualQty').value) || 0;

            if (!companyId || !lineId || !unitId) {
                showToast('Please select company, production line, and unit', 'warning');
                return;
            }

            // Check if this combination already exists
            const existingEntry = lineEntries.find(e =>
                !e.isDeleted && e.companyId == companyId && e.lineId == lineId && e.unitId == unitId
            );

            if (existingEntry) {
                showToast('This company, line, and unit combination already exists!', 'warning');
                return;
            }

            const companyName = companies.find(c => c.id == companyId)?.name || '';
            const lineName = document.getElementById('modalLineSelect').options[document.getElementById('modalLineSelect').selectedIndex].text;
            const unitName = document.getElementById('modalUnitSelect').options[document.getElementById('modalUnitSelect').selectedIndex].text;

            const entry = {
                id: 0,
                companyId: parseInt(companyId),
                companyName: companyName,
                lineId: parseInt(lineId),
                lineName: lineName,
                unitId: parseInt(unitId),
                unitName: unitName,
                plannedQuantity: plannedQty,
                actualQuantity: actualQty,
                isNew: true,
                isDeleted: false
            };

            lineEntries.push(entry);
            renderTable();
            updateStats();
            bootstrap.Modal.getInstance(document.getElementById('addLineModal')).hide();
            showToast('Production line entry added successfully!', 'success');
        }

        function renderTable() {
            const tbody = document.getElementById('productionTableBody');
            const emptyState = document.getElementById('emptyState');

            tbody.innerHTML = '';

            const activeEntries = lineEntries.filter(e => !e.isDeleted);

            if (activeEntries.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            activeEntries.forEach((entry, index) => {
                const difference = entry.actualQuantity - entry.plannedQuantity;
                const performance = entry.plannedQuantity > 0 ?
                    ((entry.actualQuantity / entry.plannedQuantity) * 100) : 0;

                const performanceClass = performance >= 100 ? 'bg-success' :
                                       performance >= 80 ? 'bg-warning' : 'bg-danger';

                const performanceIcon = performance >= 100 ? 'bi-arrow-up-circle' :
                                      performance >= 80 ? 'bi-dash-circle' : 'bi-arrow-down-circle';

                const row = document.createElement('tr');
                row.className = 'fade-in';
                row.innerHTML = `
                    <td class="company-name">${entry.companyName}</td>
                    <td>
                        <span class="line-badge">${entry.lineName}</span>
                    </td>
                    <td>
                        <span class="badge bg-info">${entry.unitName || 'N/A'}</span>
                    </td>
                    <td>
                        <input type="number" class="form-control modern-input" value="${entry.plannedQuantity}"
                               min="0" step="0.01" onchange="updateEntry(${index}, 'plannedQuantity', this.value)">
                    </td>
                    <td>
                        <input type="number" class="form-control modern-input" value="${entry.actualQuantity}"
                               min="0" step="0.01" onchange="updateEntry(${index}, 'actualQuantity', this.value)">
                    </td>
                    <td>
                        <span class="difference-badge ${difference >= 0 ? 'bg-success' : 'bg-danger'}">
                            ${difference >= 0 ? '+' : ''}${difference.toFixed(2)}
                        </span>
                    </td>
                    <td>
                        <span class="performance-badge ${performanceClass}">
                            <i class="bi ${performanceIcon}"></i>
                            ${performance.toFixed(1)}%
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteEntry(${index})" title="Delete Entry">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateEntry(index, field, value) {
            const realIndex = lineEntries.findIndex((entry, i) => !entry.isDeleted && i === index);
            if (realIndex !== -1) {
                lineEntries[realIndex][field] = parseFloat(value) || 0;
            }
            renderTable();
            updateStats();
        }

        function deleteEntry(index) {
            if (confirm('Are you sure you want to delete this entry?')) {
                const activeEntries = lineEntries.filter(e => !e.isDeleted);
                const entryToDelete = activeEntries[index];
                const realIndex = lineEntries.indexOf(entryToDelete);

                if (realIndex !== -1) {
                    lineEntries[realIndex].isDeleted = true;
                }

                renderTable();
                updateStats();
                showToast('Entry deleted successfully!', 'warning');
            }
        }

        function updateStats() {
            const activeEntries = lineEntries.filter(e => !e.isDeleted);
            const totalPlanned = activeEntries.reduce((sum, e) => sum + e.plannedQuantity, 0);
            const totalActual = activeEntries.reduce((sum, e) => sum + e.actualQuantity, 0);
            const efficiency = totalPlanned > 0 ? ((totalActual / totalPlanned) * 100) : 0;

            document.getElementById('totalEntries').textContent = activeEntries.length;
            document.getElementById('plannedTotal').textContent = totalPlanned.toFixed(2);
            document.getElementById('actualTotal').textContent = totalActual.toFixed(2);
            document.getElementById('efficiency').textContent = efficiency.toFixed(1) + '%';
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data?')) {
                lineEntries = [];
                renderTable();
                updateStats();
                showToast('All data cleared!', 'info');
            }
        }

        function loadDataForDate() {
            const date = document.getElementById('productionDate').value;

            fetch(`/DataEntry/GetCompanyUnitEntries?departmentId=${departmentId}&date=${date}`)
                .then(response => response.json())
                .then(data => {
                    lineEntries = data.map(entry => ({
                        ...entry,
                        isNew: false,
                        isDeleted: false
                    }));
                    renderTable();
                    updateStats();
                })
                .catch(error => {
                    console.error('Error loading existing data:', error);
                    renderTable();
                    updateStats();
                });
        }

        function loadExistingData() {
            // Load existing entries from server for current date
            loadDataForDate();
        }

        function saveUpperData() {
            const validEntries = lineEntries.filter(e => !e.isDeleted);

            if (validEntries.length === 0) {
                showToast('No data to save. Please add some production entries first.', 'warning');
                return;
            }

            const data = {
                date: document.getElementById('productionDate').value,
                periodType: 'Weekly',
                companyUnitEntries: validEntries.map(entry => ({
                    id: entry.id,
                    companyId: entry.companyId,
                    companyName: entry.companyName,
                    unitId: entry.unitId,
                    unitName: entry.unitName,
                    plannedQuantity: entry.plannedQuantity,
                    actualQuantity: entry.actualQuantity,
                    isNew: entry.isNew,
                    isDeleted: entry.isDeleted
                }))
            };

            // Show loading state
            const saveButton = document.querySelector('button[onclick="saveUpperData()"]');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Saving...';
            saveButton.disabled = true;

            fetch('/DataEntry/SaveUpperEntry', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast(result.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showToast('Error: ' + result.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error saving data', 'danger');
            })
            .finally(() => {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            });
        }

        // Toast notification function
        function showToast(message, type) {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }

            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.style.borderRadius = '15px';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body fw-bold">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            toastContainer.appendChild(toast);

            const bsToast = new bootstrap.Toast(toast, { delay: 4000 });
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Additional styling for toast notifications
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                .toast-container .toast {
                    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
                }
                .toast.bg-success {
                    background: var(--upper-gradient) !important;
                }
                .toast.bg-warning {
                    background: var(--warning-gradient) !important;
                }
                .toast.bg-danger {
                    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%) !important;
                }
                .toast.bg-info {
                    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%) !important;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
}